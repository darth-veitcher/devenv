# compose.yml (devcontainer)
version: "3.8"

services:
  devcontainer:
    build: .
    volumes:
      - ..:/workspace
      # - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - shared # Add shared network for app communication
    command: sleep infinity
    cap_add:
      - NET_ADMIN
      - NET_RAW
    extra_hosts:
      - host.docker.internal:host-gateway # access host's `localhost` using `host.docker.internal`
{% if cookiecutter.database_backend == 'postgresql' %}
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:{{ cookiecutter.postgres_version }}-alpine
    container_name: {{ cookiecutter.project_slug }}-postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: {{ cookiecutter.postgres_user }}
      POSTGRES_PASSWORD: {{ cookiecutter.postgres_password }}
      POSTGRES_DB: {{ cookiecutter.postgres_db }}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - shared
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ cookiecutter.postgres_user }} -d {{ cookiecutter.postgres_db }}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
{% endif %}

networks:
  shared:
    # This network allows host access for your app
    driver: bridge
{% if cookiecutter.database_backend == 'postgresql' %}

volumes:
  postgres_data:
{% endif %}
